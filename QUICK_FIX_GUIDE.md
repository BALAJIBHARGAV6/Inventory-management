# üö® Quick Fix Guide - CORS Errors

## Your Current Error

```
Access to fetch from backend has been blocked by CORS policy
```

## ‚úÖ Solution - Deploy to Render

### Step 1: Update Backend Environment Variable on Render

1. Go to https://dashboard.render.com/
2. Select your service: `inventory-management-backend`
3. Go to **Environment** tab
4. Add/Update `CORS_ORIGIN`:
   ```
   https://inventory-management-ecommerce.vercel.app,*.vercel.app,http://localhost:3000
   ```
5. Save changes (service auto-redeploys)

### Step 2: Verify Backend is Running

Test health endpoint:
```bash
curl https://your-app.onrender.com/health
```

Expected response:
```json
{
  "status": "ok",
  "timestamp": "2024-01-18T...",
  "database": "configured",
  "environment": "production"
}
```

Replace `your-app` with your actual Render service name.

### Step 3: Clear Browser Cache

1. Open DevTools (F12)
2. Right-click refresh button
3. Select "Empty Cache and Hard Reload"
4. Or use: `Ctrl + Shift + R` (Windows) / `Cmd + Shift + R` (Mac)

### Step 4: Verify Frontend Environment

**On Vercel:**
1. Go to https://vercel.com/dashboard
2. Select your project
3. Settings ‚Üí Environment Variables
4. Verify `NEXT_PUBLIC_API_URL` matches your Render backend:
   ```
   NEXT_PUBLIC_API_URL=https://your-app.onrender.com
   ```
   Replace `your-app` with your actual Render service name
5. Redeploy if changed (Deployments ‚Üí Redeploy)

---

## ÔøΩ Deploy to Render (Complete Guide)

### Why Render?
- ‚úÖ Reliable free tier
- ‚úÖ Fast deployment
- ‚úÖ Easy configuration with `render.yaml`
- ‚úÖ Built-in SSL
- ‚úÖ Excellent logging

### Deployment Steps

#### 1. Prepare Your Environment Variables

You'll need:
- `SUPABASE_URL` - From Supabase dashboard
- `SUPABASE_SERVICE_KEY` - From Supabase (service_role key)
- `GROQ_API_KEY` - From Groq Console
- `CORS_ORIGIN` - Your Vercel URL

See [ENV_VARIABLES_GUIDE.md](./ENV_VARIABLES_GUIDE.md) for detailed instructions.

#### 2. Deploy to Render

**Option A: Using Blueprint (Recommended)**
1. Push code to GitHub:
   ```bash
   git add .
   git commit -m "Add Render configuration"
   git push origin main
   ```

2. Go to https://dashboard.render.com/
3. Click **New +** ‚Üí **Blueprint**
4. Connect your GitHub repository
5. Render detects `render.yaml` automatically
6. Click **Apply**

**Option B: Manual Setup**
1. Go to https://dashboard.render.com/
2. Click **New +** ‚Üí **Web Service**
3. Connect GitHub repository
4. Configure:
   - **Name**: `inventory-management-backend`
   - **Region**: Singapore (or closest)
   - **Branch**: `main`
   - **Build Command**: `cd backend && npm install && npm run build`
   - **Start Command**: `cd backend && npm start`

#### 3. Add Environment Variables to Render

```
SUPABASE_URL=<from Railway>
SUPABASE_SERVICE_KEY=<from Railway>
GROQ_API_KEY=<from Railway>
CORS_ORIGIN=https://inventory-management-ecommerce.vercel.app,*.vercel.app,http://localhost:3000
NODE_ENV=production
PORT=4000
```

**JWT_SECRET** will be auto-generated by Render.

#### 4. Update Vercel Frontend

1. Go to Vercel Dashboard
2. Your project ‚Üí Settings ‚Üí Environment Variables
3. Update `NEXT_PUBLIC_API_URL`:
   ```
   NEXT_PUBLIC_API_URL=https://your-app.onrender.com
   ```
   (Replace with your actual Render URL)
4. Go to Deployments tab
5. Click **Redeploy** on latest deployment

#### 5. Test Everything

```bash
# Test backend health
curl https://your-app.onrender.com/health

# Test products API
curl https://your-app.onrender.com/api/products?limit=10

# Test inventory stats
curl https://your-app.onrender.com/api/inventory/stats

# Test orders
curl https://your-app.onrender.com/api/orders/admin/all
```

#### 6. Verify Frontend

1. Visit: `https://inventory-management-ecommerce.vercel.app/admin`
2. Check all tabs load data:
   - ‚úÖ Dashboard
   - ‚úÖ Products
   - ‚úÖ Inventory
   - ‚úÖ Orders
   - ‚úÖ AI Forecasting

---

## üîç Troubleshooting Checklist

### CORS Still Not Working?

- [ ] Backend `CORS_ORIGIN` includes exact Vercel URL
- [ ] Backend `CORS_ORIGIN` includes `*.vercel.app`
- [ ] Backend redeployed after env var change
- [ ] Browser cache cleared (hard refresh)
- [ ] Check backend logs for "CORS blocked origin:" messages

### API Returning 404?

- [ ] Backend is running (check `/health`)
- [ ] `NEXT_PUBLIC_API_URL` in Vercel is correct
- [ ] No trailing slash in API URL
- [ ] API routes exist (check backend logs)

### Database Errors?

- [ ] `SUPABASE_URL` is correct
- [ ] Using `SUPABASE_SERVICE_KEY` (not anon key) in backend
- [ ] Database schema is created
- [ ] Tables exist in Supabase

### React Errors (#425, #422)?

These are usually caused by:
1. **CORS blocking API calls** ‚Üí Fix CORS first
2. **API returning errors** ‚Üí Check backend logs
3. **Missing data** ‚Üí Verify database has data

**Fix order:**
1. Fix CORS configuration
2. Verify backend health
3. Check database connection
4. Test API endpoints
5. Clear browser cache
6. Reload frontend

---

## üìã Environment Variables Reference

### Backend (Render/Railway)

| Variable | Description | Example |
|----------|-------------|---------|
| `SUPABASE_URL` | Supabase project URL | `https://abc123.supabase.co` |
| `SUPABASE_SERVICE_KEY` | Service role key | `eyJhbGc...` |
| `GROQ_API_KEY` | Groq AI API key | `gsk_...` |
| `CORS_ORIGIN` | **CRITICAL** Allowed origins | See below |
| `JWT_SECRET` | JWT signing key | Auto-generated |
| `NODE_ENV` | Environment | `production` |
| `PORT` | Server port | `4000` |

### Frontend (Vercel)

| Variable | Description | Example |
|----------|-------------|---------|
| `NEXT_PUBLIC_API_URL` | Backend API URL | `https://your-app.onrender.com` |
| `NEXT_PUBLIC_SUPABASE_URL` | Supabase URL | `https://abc123.supabase.co` |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Supabase anon key | `eyJhbGc...` |

### CORS_ORIGIN Format

**Correct:**
```
https://inventory-management-ecommerce.vercel.app,*.vercel.app,http://localhost:3000
```

**Incorrect:**
```
# Missing wildcard for preview deployments
https://inventory-management-ecommerce.vercel.app

# Missing commas
https://inventory-management-ecommerce.vercel.app *.vercel.app

# Extra spaces
https://inventory-management-ecommerce.vercel.app, *.vercel.app
```

---

## üÜò Still Having Issues?

### Check Logs

**Render:**
1. Dashboard ‚Üí Your Service ‚Üí Logs
2. Look for errors during startup
3. Check for CORS messages

**Railway:**
1. Dashboard ‚Üí Your Service ‚Üí Deployments
2. Click latest deployment ‚Üí View Logs

**Vercel:**
1. Dashboard ‚Üí Your Project ‚Üí Deployments
2. Click latest ‚Üí View Function Logs

### Common Log Messages

**Good:**
```
üöÄ Server running at http://0.0.0.0:4000
SUPABASE_URL loaded: YES
SUPABASE_SERVICE_KEY loaded: YES
```

**Bad:**
```
CORS blocked origin: https://inventory-management-ecommerce.vercel.app
SUPABASE_URL loaded: NO
Error: Cannot connect to database
```

### Test Locally

```bash
# Backend
cd backend
npm install
npm run dev

# Frontend (in new terminal)
cd frontend
npm install
npm run dev
```

Visit: http://localhost:3000/admin

---

## ‚úÖ Success Checklist

After fixing, verify:

- [ ] Backend `/health` returns 200 OK
- [ ] No CORS errors in browser console
- [ ] Admin dashboard loads without errors
- [ ] Products tab shows data
- [ ] Inventory tab shows stats
- [ ] Orders tab shows orders
- [ ] AI Forecasting tab works
- [ ] Can create/edit products
- [ ] Can approve/reject orders

---

## üìû Quick Commands

```bash
# Test backend health
curl https://your-backend-url/health

# Test with CORS headers
curl -H "Origin: https://inventory-management-ecommerce.vercel.app" \
     -H "Access-Control-Request-Method: GET" \
     -H "Access-Control-Request-Headers: Content-Type" \
     -X OPTIONS \
     https://your-backend-url/api/products

# Check if endpoint exists
curl -I https://your-backend-url/api/products

# View backend logs (Render)
# Dashboard ‚Üí Service ‚Üí Logs tab

# Redeploy Vercel
# Dashboard ‚Üí Deployments ‚Üí Click "..." ‚Üí Redeploy
```

---

**Last Updated:** January 18, 2024
**Status:** Ready for deployment
